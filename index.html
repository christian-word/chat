<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Библия</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    select {
      margin: 5px;
      padding: 5px;
    }
    .verse {
      margin: 6px 0;
      line-height: 1.5;
    }
    .verse-number {
      font-weight: bold;
      color: #333;
    }
    .highlight {
      background: #fff3cd;
      transition: background 0.5s ease;
    }
  </style>
</head>

<script>
  console.log('getBibleText:', typeof getBibleText);
</script>
<body>
  <h1>Библия</h1>

  <div>
    <label>Книга:</label>
    <select id="bookSelect"></select>

    <label>Глава:</label>
    <select id="chapterSelect"></select>

    <label>Стих:</label>
    <select id="verseSelect">
      <option value="">—</option>
    </select>
  </div>

  <div id="verses" style="margin-top: 20px;"></div>

  <!-- Подключаем скрипт утилит -->
  <script>
const BIBLE_URL = 'https://raw.githubusercontent.com/christian-word/bible-planner/refs/heads/main/json/bible.json';
let __bibleData = null;

function parseVerseInput(input) {
  if (!input) return null;
  const parts = input.split(',');
  const result = new Set();
  for (let part of parts) {
    part = part.trim();
    if (part.includes('-')) {
      const [start, end] = part.split('-').map(Number);
      if (isNaN(start) || isNaN(end)) continue;
      for (let i = start; i <= end; i++) result.add(i);
    } else {
      const num = Number(part);
      if (!isNaN(num)) result.add(num);
    }
  }
  return Array.from(result).sort((a, b) => a - b);
}

async function getBibleText(params) {
  if (!__bibleData) {
    const res = await fetch(BIBLE_URL);
    if (!res.ok) return { error: 'Не удалось загрузить bible.json' };
    __bibleData = await res.json();
  }

  const { book, chapter, verse } = params;
  const bookIndex = book - 1;
  if (bookIndex < 0 || bookIndex >= __bibleData.length) {
    return { error: 'Книга с таким номером не найдена' };
  }

  const bookObj = __bibleData[bookIndex];
  const chapterIndex = chapter - 1;
  if (!bookObj.chapters || chapterIndex < 0 || chapterIndex >= bookObj.chapters.length) {
    return { error: 'Глава не найдена в выбранной книге' };
  }

  const verses = bookObj.chapters[chapterIndex].verses;
  if (!verse) return verses;

  const verseNums = parseVerseInput(verse);
  const result = [];
  for (const vNum of verseNums) {
    const found = verses.find(v => v.verse === vNum);
    if (!found) return { error: `Стих ${vNum} не найден в главе` };
    result.push(found);
  }
  return result;
}
</script>

  <script>
    let __bookNames = []; // для отображения

    async function init() {
      const data = await getBibleText({ book: 1, chapter: 1 }); // загружаем для инициализации
      const selectBook = document.getElementById('bookSelect');

      // заполняем список книг
      if (!window.__bibleData) return;
      __bibleData.forEach((book, index) => {
        __bookNames.push(book.book);
        const opt = document.createElement('option');
        opt.value = index + 1;
        opt.textContent = book.book;
        selectBook.appendChild(opt);
      });

      selectBook.addEventListener('change', updateChapters);
      document.getElementById('chapterSelect').addEventListener('change', updateVerses);
      document.getElementById('verseSelect').addEventListener('change', showContent);

      selectBook.value = 1;
      updateChapters();
    }

    function updateChapters() {
      const bookNum = +document.getElementById('bookSelect').value;
      const chapterSelect = document.getElementById('chapterSelect');
      chapterSelect.innerHTML = '';

      const chapters = window.__bibleData[bookNum - 1].chapters || [];
      chapters.forEach((ch, idx) => {
        const opt = document.createElement('option');
        opt.value = idx + 1;
        opt.textContent = ch.chapter || (idx + 1);
        chapterSelect.appendChild(opt);
      });

      updateVerses();
    }

    function updateVerses() {
      const bookNum = +document.getElementById('bookSelect').value;
      const chapterNum = +document.getElementById('chapterSelect').value;

      const verseSelect = document.getElementById('verseSelect');
      verseSelect.innerHTML = '<option value="">—</option>';

      const verses = window.__bibleData[bookNum - 1].chapters[chapterNum - 1].verses || [];
      verses.forEach((v) => {
        const opt = document.createElement('option');
        opt.value = v.verse;
        opt.textContent = v.verse;
        verseSelect.appendChild(opt);
      });

      showContent();
    }

    async function showContent() {
      const book = +document.getElementById('bookSelect').value;
      const chapter = +document.getElementById('chapterSelect').value;
      const verse = document.getElementById('verseSelect').value;

      const result = await getBibleText({
        book,
        chapter,
        verse: verse ? verse : undefined
      });

      const versesDiv = document.getElementById('verses');
      versesDiv.innerHTML = '';

      if (result.error) {
        versesDiv.textContent = result.error;
        return;
      }

      result.forEach(v => {
        const div = document.createElement('div');
        div.className = 'verse' + (verse && v.verse == verse ? ' highlight' : '');
        div.innerHTML = `<span class="verse-number">${v.verse}</span> ${v.text}`;
        versesDiv.appendChild(div);
      });
    }

    init();
  </script>
</body>
</html>

