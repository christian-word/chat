<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Біблійний Асистент 2</title>
<style>
  :root {
    --accent: #ffcc00;
    --bg: #f6f7fb;
    --card: #ffffff;
    --text: #222;
    --muted: #666;
    --primary: #1a73e8;
    --success: #2f7d32;
    --danger: #b00020;
  }
  [data-theme="dark"] {
    --bg: #1a1a1a;
    --card: #2d2d2d;
    --text: #ffffff;
    --muted: #aaaaaa;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; background: var(--bg); color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  header {
    max-width: 960px; margin: 16px auto 0; padding: 0 12px 8px;
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
  }
  header h1 { margin: 0 0 6px; font-size: 20px; font-weight: 700; }
  header .hint { color: var(--muted); font-size: 13px; }
  #controls {
    max-width: 960px; margin: 10px auto; padding: 12px;
    background: var(--card); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.05);
    display: grid; grid-template-columns: 1fr 260px auto; gap: 8px; align-items: center;
  }
  #model { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 10px; }
  #send-btn, #clear-btn, #reload-btn, #settings-btn, #questions-btn, #help-btn {
    padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 600;
  }
  #send-btn { background: var(--success); color: #fff; }
  #send-btn:disabled { opacity: .6; cursor: not-allowed; }
  #questions-btn, #help-btn { background: #eee; }
  #clear-btn, #settings-btn { background: #eee; }
  #reload-btn { background: var(--primary); color: #fff; }
  #chat {
    max-width: 960px; margin: 10px auto; padding: 16px 12px 4px;
    background: var(--card); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.05);
    height: 62vh; overflow-y: auto;
  }
  .msg { margin: 8px 0 16px; line-height: 1.5; }
  .role { font-weight: 700; margin-right: 6px; }
  .ai .role { color: var(--primary); }
  .you .role { color: var(--success); }
  #input-area {
    max-width: 960px; margin: 10px auto 22px; padding: 12px;
    background: var(--card); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.05);
    display: grid; grid-template-columns: 1fr auto auto; gap: 10px;
  }
  #user-input { padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 10px; }
  .muted { color: var(--muted); }
  code.inline { background: #f2f2f2; padding: 2px 4px; border-radius: 4px; }
  a.inline { color: var(--primary); text-decoration: underline; word-break: break-all; }
  .bible-ref { color: var(--primary); text-decoration: underline; font-weight: 600; }
  /* Модалка */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,.35);
    display: none; align-items: center; justify-content: center; z-index: 1000;
  }
  .modal {
    width: min(920px, 96vw); max-height: 92vh; overflow: auto;
    background: var(--card); border-radius: 14px; box-shadow: 0 12px 40px rgba(0,0,0,.25);
    padding: 20px;
  }
  .modal h2 { margin: 4px 0 16px; font-size: 18px; color: var(--text); }
  .modal h3 {
    margin: 20px 0 12px; font-size: 16px; color: var(--primary);
    border-bottom: 1px solid #eee; padding-bottom: 4px;
  }
  .modal h3:first-of-type { margin-top: 0; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 13px; color: var(--muted); font-weight: 600; }
  .field input[type="text"], .field input[type="number"], .field select, .field textarea {
    width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px;
  }
  .field input[type="range"] { width: 100%; }
  .field textarea { min-height: 100px; resize: vertical; }
  .checkbox-field { display: flex; align-items: center; gap: 8px; padding: 8px 0; }
  .checkbox-field input[type="checkbox"] { margin: 0; }
  .checkbox-field label { margin: 0; font-size: 14px; color: var(--text); cursor: pointer; }
  .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .btn-primary { background: var(--primary); color: #fff; border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
  .btn-ghost { background: #eee; color: #000; border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
  .btn-danger { background: var(--danger); color: #fff; border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
  .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
  .range-display { font-size: 12px; color: var(--muted); text-align: center; }

  /* Стили для модалки с примерами вопросов */
  .question-list { display: flex; flex-direction: column; gap: 10px; }
  .question-btn {
    background: #f0f0f0; border: 1px solid #ddd; border-radius: 10px;
    padding: 10px 14px; text-align: left; cursor: pointer;
    transition: background .2s;
  }
  .question-btn:hover { background: #eaeaea; }
  [data-theme="dark"] .question-btn {
    background: #3a3a3a; border-color: #555; color: var(--text);
  }
  [data-theme="dark"] .question-btn:hover { background: #4a4a4a; }

  @media (max-width: 740px) {
    .grid2, .grid3 { grid-template-columns: 1fr; }
    #controls { grid-template-columns: 1fr; }
    #input-area { grid-template-columns: 1fr; }
    #send-btn, #questions-btn { width: 100%; margin-top: 5px; }
  }
/* 📱 МОБИЛЬНЫЕ СТИЛИ ДЛЯ БИБЛЕЙСКОГО ЧАТА */

/* Базовые мобильные стили */
@media (max-width: 768px) {
  body {
    font-size: 14px;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Заголовок */
  header {
    flex-direction: column;
    gap: 8px;
    padding: 12px 60px 12px 16px; /* Отступ справа для кнопки */
    text-align: center;
    background: var(--card);
    box-shadow: 0 2px 8px rgba(0,0,0,.1);
    position: sticky;
    top: 0;
    z-index: 100;
    position: relative; /* Для позиционирования кнопки */
  }

  header h1 {
    font-size: 18px;
    margin: 0;
  }

  header .hint {
    font-size: 12px;
    line-height: 1.4;
  }

  #settings-btn {
    position: absolute;
    top: 12px;
    right: 0px;
    font-size: 18px;
    padding: 8px;
    min-width: 36px;
    height: 36px;
    border-radius: 8px;
    background: #f0f0f0;
    border: 1px solid #ddd;
  }

  /* Скрываем текст на мобильных */
  #settings-btn {
    font-size: 0; /* Скрываем текст */
  }
  
  #settings-btn::before {
    content: "⚙";
    font-size: 18px;
    display: inline-block;
  }

  /* Контролы */
  #controls {
    margin: 8px 12px;
    padding: 12px;
    grid-template-columns: 1fr;
    gap: 12px;
    border-radius: 8px;
  }

  #model-count {
    font-size: 12px;
    text-align: center;
  }

  #model {
    padding: 10px;
    font-size: 14px;
    border-radius: 8px;
  }

  #controls > div:last-child {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  #reload-btn, #clear-btn, #help-btn {
    flex: 1;
    padding: 10px;
    font-size: 14px;
    border-radius: 8px;
  }

  /* Чат */
  #chat {
    flex: 1;
    margin: 8px 12px;
    padding: 16px 12px;
    height: auto;
    min-height: 200px;
    max-height: none;
    overflow-y: auto;
    border-radius: 8px;
    /* Отступ снизу для области ввода */
    margin-bottom: 8px;
  }

  .msg {
    margin: 12px 0;
    line-height: 1.6;
    word-wrap: break-word;
  }

  .role {
    display: block;
    margin-bottom: 4px;
    font-size: 13px;
  }

  .text {
    display: block;
    font-size: 14px;
  }

  /* Область ввода */
  #input-area {
    margin: 0 12px 12px;
    padding: 12px;
    grid-template-columns: 1fr;
    gap: 10px;
    border-radius: 8px;
    /* Фиксированная позиция внизу */
    position: sticky;
    bottom: 0;
    background: var(--card);
    box-shadow: 0 -2px 8px rgba(0,0,0,.1);
  }

  #user-input {
    width: 100%;
    padding: 12px;
    font-size: 16px; /* Предотвращает зум на iOS */
    border-radius: 8px;
    border: 1px solid #ddd;
    min-height: 20px;
    resize: none;
  }

  #send-btn, #questions-btn {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    border-radius: 8px;
    font-weight: 600;
    margin-top: 5px;
  }

  /* Модальное окно */
  .modal {
    width: 95vw;
    max-width: none;
    height: 90vh;
    max-height: 90vh;
    margin: 5vh auto;
    padding: 16px;
    border-radius: 12px;
    overflow-y: auto;
  }

  .modal h2 {
    font-size: 16px;
    margin-bottom: 12px;
    text-align: center;
  }

  .modal h3 {
    font-size: 14px;
    margin: 16px 0 8px;
  }

  /* Сетки в модалке */
  .grid2, .grid3 {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .field {
    gap: 4px;
  }

  .field label {
    font-size: 12px;
  }

  .field input,
  .field select,
  .field textarea {
    padding: 10px;
    font-size: 14px;
    border-radius: 8px;
  }

  .field textarea {
    min-height: 80px;
  }

  .checkbox-field {
    padding: 6px 0;
  }

  .checkbox-field label {
    font-size: 13px;
  }

  .modal-footer {
    margin-top: 16px;
    flex-wrap: wrap;
    gap: 8px;
  }

  .modal-footer button {
    flex: 1;
    min-width: 100px;
    padding: 10px;
    font-size: 14px;
  }

  /* Улучшения для читаемости */
  .bible-ref {
    word-break: break-word;
  }

  a.inline {
    word-break: break-all;
    color: var(--primary);
  }

  .muted {
    font-size: 13px;
  }

  /* Отзывчивые кнопки */
  button {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  /* Скрытие полос прокрутки на мобильных */
  #chat::-webkit-scrollbar,
  .modal::-webkit-scrollbar {
    width: 0px;
    background: transparent;
  }
}

/* Очень маленькие экраны */
@media (max-width: 480px) {
  header {
    padding: 8px 50px 8px 12px; /* Еще больше места для кнопки */
  }

  header h1 {
    font-size: 16px;
  }

  header .hint {
    font-size: 11px;
  }

  #settings-btn {
    top: 8px;
    right: 12px;
    font-size: 0; /* Текст скрыт */
    padding: 6px;
    min-width: 32px;
    height: 32px;
  }
  
  #settings-btn::before {
    font-size: 16px;
  }

  #controls {
    margin: 6px 8px;
    padding: 10px;
  }

  #chat {
    margin: 6px 8px;
    padding: 12px 8px;
  }

  #input-area {
    margin: 0 8px 8px;
    padding: 10px;
  }

  .modal {
    width: 98vw;
    height: 95vh;
    margin: 2.5vh auto;
    padding: 12px;
  }

  .modal h2 {
    font-size: 15px;
  }

  .modal h3 {
    font-size: 13px;
  }
}

/* Ландшафтная ориентация на мобильных */
@media (max-width: 768px) and (orientation: landscape) {
  #chat {
    height: auto;
    min-height: 150px;
  }

  .modal {
    height: 85vh;
    max-height: 85vh;
  }
}

/* Анимации для лучшего UX */
@media (max-width: 768px) {
  .modal-backdrop {
    animation: fadeIn 0.2s ease-out;
  }

  .modal {
    animation: slideUp 0.3s ease-out;
  }

  #send-btn:active {
    transform: scale(0.98);
  }

  button:active {
    transform: scale(0.95);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Улучшения для доступности на мобильных */
@media (max-width: 768px) {
  /* Увеличенные области касания */
  button,
  input,
  select {
    min-height: 44px;
  }

  /* Лучшая видимость фокуса */
  input:focus,
  select:focus,
  textarea:focus,
  button:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  /* Предотвращение случайного зума */
  input[type="text"],
  input[type="number"],
  textarea,
  select {
    font-size: 16px;
  }
}

/* Темная тема для всех элементов */
[data-theme="dark"] #user-input,
[data-theme="dark"] #model,
[data-theme="dark"] .field input,
[data-theme="dark"] .field select,
[data-theme="dark"] .field textarea {
  background: var(--card);
  color: var(--text);
  border-color: #555;
}

[data-theme="dark"] .btn-ghost {
  background: #555;
  color: var(--text);
}
</style>
</head>
<body>

<header>
  <div>
    <h1>Біблійний чат ІІ</h1>
    <div class="hint">Розширений режим з налаштуваннями</div>
  </div>
  <button id="settings-btn" title="Налаштування">⚙ Налаштування</button>
</header>

<section id="controls">
  <span id="model-count" class="muted">Моделей завантажено: 0</span>
  <select id="model" title="Модель"></select>
  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button id="help-btn">🆘 Допомога</button>
    <button id="reload-btn">Оновити моделі</button>
    <button id="clear-btn">Очистити</button>
  </div>
</section>

<section id="chat" aria-live="polite" aria-busy="false"></section>

<section id="input-area">
  <input id="user-input" type="text" placeholder="Напишіть запитання..." />
  <button id="send-btn">Надіслати</button>
  <button id="questions-btn">❓ Питання</button>
</section>

<!-- МОДАЛКА З ПРИКЛАДАМИ ПИТАНЬ -->
<div id="questions-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <h2>❓ Приклади питань</h2>
    <div class="question-list">
      <button class="question-btn">Надрукуй Псалом 23 повністю.</button>
      <button class="question-btn">Покажи молитву "Отче наш" у перекладі Огієнка.</button>
      <button class="question-btn">Хто сказав: "Я є дорога, правда і життя"?</button>
      <button class="question-btn">Знайди вірші, де апостол Павло пише про віру і благодать.</button>
      <button class="question-btn">Порівняй Івана 3:16 у перекладах Огієнка та Куліша.</button>
      <button class="question-btn">Покажи різницю між перекладами Буття 1:1.</button>
      <button class="question-btn">Стисло поясни контекст історії про блудного сина (Лк. 15:11-32).</button>
      <button class="question-btn">Знайди паралельні місця про Заповіді у Вихід 20 та Второзаконня 5.</button>
      <button class="question-btn">Знайди три місця, де говориться про любов Божу.</button>
      <button class="question-btn">Покажи приклади віршів про прощення у Новому Заповіті.</button>
    </div>
    <div style="margin-top:20px; text-align:right;">
      <button id="close-questions" class="btn-ghost">Закрити</button>
    </div>
  </div>
</div>

<!-- МОДАЛЬНЕ ВІКНО ДОПОМОГИ -->
<div id="help-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <h2>📚 Допомога</h2>
    <div style="line-height: 1.6; font-size: 14px;">
      <h3>📖 Як користуватися Біблійним чатом</h3>
      <p>1. Введіть своє запитання у текстове поле та натисніть "Надіслати"</p>
      <p>2. Використовуйте кнопку "❓ Питання" для прикладів</p>
      <p>3. Налаштуйте чат через "⚙ Налаштування"</p>
      
      <h3>💡 Поради</h3>
      <p>• Будьте конкретні: "Що означає притча про блудного сина?"</p>
      <p>• Для цитат вказуйте книгу та вірш: "Наведи Матвія 5:3-12"</p>
      <p>• Порівнюйте переклади: "Порівняй Ів. 1:1 у Огієнка та Куліша"</p>
      
      <h3>⚙️ Основні функції</h3>
      <p>• Темна/світла тема</p>
      <p>• 5 перекладів Біблії</p>
      <p>• Налаштування довжини відповідей</p>
    </div>
    <div class="modal-footer">
      <button id="close-help" class="btn-primary">Зрозуміло!</button>
    </div>
  </div>
</div>

<!-- МОДАЛЬНЕ ВІКНО НАЛАШТУВАНЬ -->
<div id="settings-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <h2>⚙ Налаштування Біблійного чату</h2>

    <!-- Тема -->
    <h3>🎨 Тема</h3>
    <div class="checkbox-field">
      <input type="checkbox" id="darkModeToggle" />
      <label for="darkModeToggle">Темна тема</label>
    </div>
    <div id="current-theme" class="muted" style="margin-top:8px; font-size:13px;"></div>

    <!-- Система -->
    <h3>✨ Система та Промт</h3>
    <div class="field">
      <label for="systemPrompt">Системний промт</label>
      <textarea id="systemPrompt" spellcheck="false" placeholder="Основні інструкції для AI асистента..."></textarea>
      <div class="row">
        <button id="reset-prompt" class="btn-ghost">Скинути до заводського</button>
      </div>
    </div>

    <div class="grid2">
      <div class="field">
        <label for="defaultModel">Модель за замовчуванням</label>
        <input id="defaultModel" type="text" placeholder="meta-llama/llama-4-maverick-17b-128e-instruct" />
      </div>
      <div class="field">
        <label for="responseLang">Мова відповіді</label>
        <select id="responseLang">
          <option value="uk">Українська</option>
          <option value="ru">Російська</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>

    <!-- Біблія -->
    <h3>📖 Налаштування Біблії</h3>
    <div class="grid2">
      <div class="field">
        <label for="translation">Переклад Біблії</label>
        <select id="translation">
          <option value="uk_ogienko">Огієнка (укр.)</option>
          <option value="uk_kulysh">Куліша (укр.)</option>
          <option value="uk_ubs2011">UBS 2011 (укр.)</option>
          <option value="ru_synodal">Синодальний (рос.)</option>
          <option value="en_kjv">KJV (англ.)</option>
        </select>
      </div>
      <div class="field">
        <label for="quoteFormat">Формат цитат</label>
        <select id="quoteFormat">
          <option value="text_with_nums">Текст з номерами віршів</option>
          <option value="text_only">Тільки текст</option>
        </select>
      </div>
    </div>

    <div class="grid2">
      <div class="field">
        <label for="quoteScope">Обсяг цитат</label>
        <select id="quoteScope">
          <option value="single">1 вірш</option>
          <option value="context">Контекст (кілька віршів)</option>
          <option value="chapter">Ціла глава</option>
        </select>
      </div>
      <div class="field">
        <label for="keywords">Ключові слова (через кому)</label>
        <input id="keywords" type="text" placeholder="віра, благодать, спасіння" />
      </div>
    </div>

    <div class="grid2">
      <div class="checkbox-field">
        <input type="checkbox" id="compareUk" />
        <label for="compareUk">Порівнювати з іншими укр. перекладами</label>
      </div>
      <div class="checkbox-field">
        <input type="checkbox" id="addCommentary" />
        <label for="addCommentary">Додавати короткі коментарі</label>
      </div>
    </div>

    <!-- AI Параметри -->
    <h3>🎛 Параметри AI</h3>
    <div class="grid3">
      <div class="field">
        <label for="temperature">Креативність</label>
        <input type="range" id="temperature" min="0" max="1" step="0.1" />
        <div class="range-display" id="temperature-display">0.6</div>
      </div>
      <div class="field">
        <label for="maxTokens">Макс. довжина відповіді</label>
        <input type="number" id="maxTokens" min="100" max="4000" step="100" />
      </div>
      <div class="checkbox-field">
        <input type="checkbox" id="shortAnswers" />
        <label for="shortAnswers">Відповідати коротко</label>
      </div>
    </div>

    <!-- Оформлення -->
    <h3>🎨 Оформлення та Підсвічування</h3>
    <div class="grid2">
      <div class="checkbox-field">
        <input type="checkbox" id="highlightRefs" />
        <label for="highlightRefs">Підсвічувати біблійні посилання синім</label>
      </div>
      <div class="checkbox-field">
        <input type="checkbox" id="boldKeywords" />
        <label for="boldKeywords">Виділяти ключові слова жирним</label>
      </div>
    </div>

    <!-- Історія та Збереження -->
    <h3>💾 Історія та Збереження</h3>
    <div class="grid2">
      <div class="checkbox-field">
        <input type="checkbox" id="saveHistory" />
        <label for="saveHistory">Зберігати історію чату</label>
      </div>
      <div class="checkbox-field">
        <input type="checkbox" id="rememberTheme" />
        <label for="rememberTheme">Запам'ятовувати тему розмови</label>
      </div>
    </div>

    <div class="modal-footer">
      <button id="factory-reset" class="btn-danger">Скинути все</button>
      <span style="flex:1"></span>
      <button id="close-settings" class="btn-ghost">Скасувати</button>
      <button id="save-settings" class="btn-primary">Зберегти</button>
    </div>
  </div>
</div>

<script>
/* =========================
   КЛЮЧ + ЕНДПОІНТИ (GROQ)
   ========================= */
const encrypted = "Z3NrX1NUelQyS1FFQko3MGNDb1hDSllaV0dkeWIzRlk5OHJHN2xvWXUxSmc1SnV0VFZOSzIyVHY=";
const apiKey = atob(encrypted);
const API_BASE = "https://api.groq.com/openai/v1";
const API_URL = `${API_BASE}/chat/completions`;
const MODELS_URL = `${API_BASE}/models`;

/* =========================
   КЛЮЧІ LOCALSTORAGE
   ========================= */
const STORAGE_KEY = "bibleChatUnifiedV1";
const CHAT_HISTORY_KEY = "bibleChatHistoryV1";

/* =========================
   НАЛАШТУВАННЯ (за замовч.)
   ========================= */
const DEFAULT_PROMPT = `Ти — асистент-богослов і знавець Біблії. Відповідай стисло, точно і з повагою.
Дотримуйся цих правил:
- Завжди тримайся біблійної теми, уникай оффтопу.
- Якщо наводиш цитати, вказуй книгу, розділ і вірші.
- За можливості пояснюй контекст (хто говорить, кому, у якій ситуації).
- Якщо користувач просить порівняння перекладів — наведи кілька українських.
- Якщо запит виходить за межі Біблії — ввічливо зазнач це і дай мінімально корисну довідку.`;

const DEFAULT_SETTINGS = {
  // Система
  systemPrompt: DEFAULT_PROMPT,
  defaultModel: "meta-llama/llama-4-maverick-17b-128e-instruct",
  responseLang: "uk",

  // Біблія
  translation: "uk_ogienko",
  compareUk: false,
  quoteFormat: "text_with_nums",
  quoteScope: "single",
  addCommentary: false,
  keywords: "",

  // AI Параметри
  temperature: 0.6,
  maxTokens: 1024,
  shortAnswers: false,

  // Оформлення
  highlightRefs: true,
  boldKeywords: false,

  // Історія
  saveHistory: false,
  rememberTheme: false
};

/* =========================
   СТАН
   ========================= */
let settings = {...DEFAULT_SETTINGS};
let chatHistory = []; // загрузимо нижче
let isLoading = false;

/* =========================
   УТИЛІТИ
   ========================= */
function escapeHTML(str) {
  return (str ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function linkify(htmlEscaped) {
  return htmlEscaped.replace(/(https?:\/\/[^\s)<>"]+)/g, '<a class="inline" href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
}
function highlightBibleRefs(htmlEscaped) {
  const re = /(\d*\s*(?:[A-Za-zА-ЯІЇЄҐа-яіїєґ\.']+\s*){1,3})\s*(\d{1,3}):(\d{1,3}(?:-\d{1,3})?)/g;
  return htmlEscaped.replace(re, '<span class="bible-ref">$1 $2:$3</span>');
}
function boldifyKeywords(htmlEscaped, keywordsCSV) {
  if (!keywordsCSV) return htmlEscaped;
  const parts = keywordsCSV.split(",").map(s => s.trim()).filter(Boolean);
  if (!parts.length) return htmlEscaped;
  const words = parts.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  const re = new RegExp(`\\b(${words.join("|")})\\b`, "gi");
  return htmlEscaped.replace(re, '<strong>$1</strong>');
}
function saferFormatAssistant(raw, s) {
  // 1) Escape всё 2) Разрешённые улучшения поверх экранированного текста
  let out = escapeHTML(raw);
  out = linkify(out);
  if (s.highlightRefs) out = highlightBibleRefs(out);
  if (s.boldKeywords) out = boldifyKeywords(out, s.keywords || "");
  return out.replace(/\n/g, "<br>");
}

/* =========================
   ЗБЕРЕЖЕННЯ/ЗАВАНТАЖЕННЯ
   ========================= */
function saveSettings() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
}
function loadSettings() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return {...DEFAULT_SETTINGS};
    const parsed = JSON.parse(raw);
    return { ...DEFAULT_SETTINGS, ...parsed };
  } catch {
    return {...DEFAULT_SETTINGS};
  }
}
function saveChatHistory() {
  if (settings.saveHistory) {
    localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory));
  }
}
function loadChatHistory() {
  if (settings.saveHistory) {
    try {
      const raw = localStorage.getItem(CHAT_HISTORY_KEY);
      if (raw) return JSON.parse(raw);
    } catch {}
  }
  // если нет истории — создаём с system
  return [{ role: "system", content: buildSystemPrompt(settings) }];
}

/* =========================
   SYSTEM PROMPT BUILDER
   ========================= */
function buildSystemPrompt(s) {
  const lines = [];
  // ВАЖЛИВО: сначала основной промпт, потом язык — чтобы язык имел высший приоритет (ниже добавим как "ВАЖЛИВО").
  if (s.systemPrompt) lines.push(s.systemPrompt.trim());

  const langMap = {
    uk: "ВАЖЛИВО: Відповідай ТІЛЬКИ українською мовою.",
    ru: "ВАЖНО: Отвечай ТОЛЬКО на русском языке.",
    en: "IMPORTANT: Answer ONLY in English."
  };
  if (langMap[s.responseLang]) lines.push(langMap[s.responseLang]);

  const trMap = {
    uk_ogienko: "Використовуй переклад Огієнка як основний, якщо потрібні цитати.",
    uk_kulysh: "Використовуй переклад Куліша як основний, якщо потрібні цитати.",
    uk_ubs2011: "Використовуй переклад Українського Біблійного Товариства (2011) як основний.",
    ru_synodal: "Используй Синодальный перевод как основной при цитировании.",
    en_kjv: "Use KJV translation as the default for citations."
  };
  if (trMap[s.translation]) lines.push(trMap[s.translation]);

  if (s.quoteScope === "single") lines.push("Зазвичай наведи 1 вірш.");
  if (s.quoteScope === "context") lines.push("Додавай 1–3 сусідніх вірші для контексту.");
  if (s.quoteScope === "chapter") lines.push("Якщо просять контекст — можна навести цілу главу стисло.");
  if (s.addCommentary) lines.push("Коротко додавай богословські коментарі (1–3 речення), чітко відділяючи їх від тексту Писання.");
  if (s.rememberTheme) lines.push("Пам'ятай контекст попередніх питань і підтримуй логічну лінію розмови.");

  if (s.compareUk) lines.push("Коли доречно, додавай порівняння з іншими українськими перекладами (2–3 варіанти) і коротко коментуй різницю.");
  if (s.shortAnswers) lines.push("Відповідай стисло та по суті.");
  if (s.quoteFormat === "text_only") lines.push("Подавай цитати без номерів віршів (лише текст), але завжди вказуй джерело у круглих дужках після цитати.");
  else lines.push("Подавай цитати з номерами віршів.");
  
  // ✅ СТРОГАЯ ИНСТРУКЦИЯ О СКОБКАХ (теперь учитывает формат)
  lines.push("СТРОГО: При згадуванні біблійних джерел ЗАВЖДИ використовуй формат (Книга число:число) у круглих дужках. Приклади правильно: (Ін. 3:16), (1 Івана 4:8). Приклади НЕПРАВИЛЬНО: (**Ін. 3:16**), (****Ін. 3:16****). Зірочки * використовуйте ТІЛЬКИ для списків!");

  return lines.filter(Boolean).join("\n");
}

/* =========================
   ПРИМЕНЕНИЕ НАСТРОЕК В UI
   ========================= */
function applySettingsToUI() {
  // Система
  document.getElementById('systemPrompt').value = settings.systemPrompt;
  document.getElementById('defaultModel').value = settings.defaultModel;
  document.getElementById('responseLang').value = settings.responseLang;
  // Біблія
  document.getElementById('translation').value = settings.translation;
  document.getElementById('compareUk').checked = settings.compareUk;
  document.getElementById('quoteFormat').value = settings.quoteFormat;
  document.getElementById('quoteScope').value = settings.quoteScope;
  document.getElementById('addCommentary').checked = settings.addCommentary;
  document.getElementById('keywords').value = settings.keywords || "";
  // AI
  document.getElementById('temperature').value = settings.temperature;
  document.getElementById('temperature-display').textContent = settings.temperature;
  document.getElementById('maxTokens').value = settings.maxTokens;
  document.getElementById('shortAnswers').checked = settings.shortAnswers;
  // Оформлення
  document.getElementById('highlightRefs').checked = settings.highlightRefs;
  document.getElementById('boldKeywords').checked = settings.boldKeywords;
  // Історія
  document.getElementById('saveHistory').checked = settings.saveHistory;
  document.getElementById('rememberTheme').checked = settings.rememberTheme;
}

function gatherSettingsFromUI() {
  // Система
  settings.systemPrompt = document.getElementById('systemPrompt').value.trim() || DEFAULT_PROMPT;
  settings.defaultModel = document.getElementById('defaultModel').value.trim() || DEFAULT_SETTINGS.defaultModel;
  settings.responseLang = document.getElementById('responseLang').value;
  // Біблія
  settings.translation = document.getElementById('translation').value;
  settings.compareUk = document.getElementById('compareUk').checked;
  settings.quoteFormat = document.getElementById('quoteFormat').value;
  settings.quoteScope = document.getElementById('quoteScope').value;
  settings.addCommentary = document.getElementById('addCommentary').checked;
  settings.keywords = document.getElementById('keywords').value;
  // AI
  settings.temperature = parseFloat(document.getElementById('temperature').value);
  settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
  settings.shortAnswers = document.getElementById('shortAnswers').checked;
  // Оформлення
  settings.highlightRefs = document.getElementById('highlightRefs').checked;
  settings.boldKeywords = document.getElementById('boldKeywords').checked;
  // Історія
  const wasSave = settings.saveHistory;
  settings.saveHistory = document.getElementById('saveHistory').checked;
  settings.rememberTheme = document.getElementById('rememberTheme').checked;

  // якщо включили збереження історії — збережемо одразу
  if (!wasSave && settings.saveHistory) saveChatHistory();
}

/* =========================
   UI: повідомлення
   ========================= */
function appendMsg(role, htmlOrText, alreadySafeHTML=false) {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = `msg ${role === 'assistant' ? 'ai' : 'you'}`;
  const safe = alreadySafeHTML ? htmlOrText : escapeHTML(htmlOrText);
  div.innerHTML = `<span class="role">${role === 'assistant' ? 'ІІ' : 'Ви'}:</span> <span class="text">${safe}</span>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* =========================
   МОДЕЛІ
   ========================= */
async function loadModels(showStatus=true) {
  const modelSel = document.getElementById('model');
  const modelCountLabel = document.getElementById('model-count');
  modelSel.innerHTML = "";
  try {
    const res = await fetch(MODELS_URL, { headers: { "Authorization": `Bearer ${apiKey}` }});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const models = data?.data || [];

    // Отображаем все id
    models.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.id;
      modelSel.appendChild(opt);
    });

    // Выбор активной
    if ([...modelSel.options].some(o => o.value === settings.defaultModel)) {
      modelSel.value = settings.defaultModel;
    } else if (modelSel.options.length > 0) {
      modelSel.selectedIndex = 0;
      settings.defaultModel = modelSel.value; // синхронизируем настройку
      saveSettings();
    }

    modelCountLabel.textContent = `Моделей завантажено: ${models.length}`;
    if (showStatus) {
      appendMsg("assistant", `<span class="muted">Моделі оновлені (${models.length}). Активна модель: ${modelSel.value}</span>`, true);
    }
  } catch (e) {
    modelSel.innerHTML = "";
    modelCountLabel.textContent = "Не вдалося завантажити моделі";
    if (showStatus) {
      appendMsg("assistant", `<span class="muted">Помилка завантаження моделей: ${escapeHTML(e.message)}</span>`, true);
    }
  }
}

/* =========================
   ВІДПРАВКА
   ========================= */
async function sendMessage() {
  if (isLoading) return;
  const input = document.getElementById('user-input');
  const modelSel = document.getElementById('model');
  const msg = (input.value || "").trim();
  if (!msg) return;

  appendMsg("user", msg);
  chatHistory.push({ role: "user", content: msg });
  input.value = "";
  isLoading = true;
  document.getElementById('send-btn').disabled = true;

  // Актуалізуємо system prompt у нульовому повідомленні
  const currentSystemPrompt = buildSystemPrompt(settings);
  chatHistory[0] = { role: "system", content: currentSystemPrompt };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: modelSel.value || settings.defaultModel,
        messages: chatHistory,
        temperature: settings.temperature,
        max_tokens: settings.maxTokens
      })
    });

    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status}: ${t || res.statusText}`);
    }

    const data = await res.json();
    const reply = data?.choices?.[0]?.message?.content || "Немає відповіді.";
    chatHistory.push({ role: "assistant", content: reply });

    const formatted = saferFormatAssistant(reply, settings);
    appendMsg("assistant", formatted, true);

    saveChatHistory();
  } catch (err) {
    appendMsg("assistant", `<span class="muted">Помилка: ${escapeHTML(err.message)}</span>`, true);
  } finally {
    isLoading = false;
    document.getElementById('send-btn').disabled = false;
  }
}

/* =========================
   ОЧИЩЕННЯ
   ========================= */
function clearChat() {
  document.getElementById('chat').innerHTML = "";
  chatHistory = [{ role: "system", content: buildSystemPrompt(settings) }];
  if (settings.saveHistory) localStorage.removeItem(CHAT_HISTORY_KEY);
  appendMsg("assistant", `<span class="muted">Чат очищено.</span>`, true);
}

/* =========================
   МОДАЛКА НАЛАШТУВАНЬ
   ========================= */
const settingsBackdrop = document.getElementById('settings-backdrop');
function openSettings() {
  applySettingsToUI();
  settingsBackdrop.style.display = "flex";
  settingsBackdrop.setAttribute("aria-hidden", "false");
}
function closeSettings() {
  settingsBackdrop.style.display = "none";
  settingsBackdrop.setAttribute("aria-hidden", "true");
}
function factoryResetAll() {
  if (!confirm("Це скине всі налаштування і очистить історію чату. Продовжити?")) return;
  settings = { ...DEFAULT_SETTINGS };
  saveSettings();
  applySettingsToUI();
  localStorage.removeItem(CHAT_HISTORY_KEY);
  chatHistory = [{ role: "system", content: buildSystemPrompt(settings) }];
  document.getElementById('chat').innerHTML = "";
  appendMsg("assistant", `<span class="muted">Всі налаштування скинуто до заводських. Чат очищено.</span>`, true);
}

/* =========================
   МОДАЛКА ДОПОМОГИ
   ========================= */
const helpBackdrop = document.getElementById('help-backdrop');
function openHelp() {
  helpBackdrop.style.display = 'flex';
  helpBackdrop.setAttribute("aria-hidden", "false");
}
function closeHelp() {
  helpBackdrop.style.display = 'none';
  helpBackdrop.setAttribute("aria-hidden", "true");
}

/* =========================
   МОДАЛКА С ПРИМЕРАМИ ВОПРОСОВ
   ========================= */
const questionsBackdrop = document.getElementById('questions-backdrop');
function openQuestions() {
  questionsBackdrop.style.display = 'flex';
  questionsBackdrop.setAttribute("aria-hidden", "false");
}
function closeQuestions() {
  questionsBackdrop.style.display = 'none';
  questionsBackdrop.setAttribute("aria-hidden", "true");
}

/* =========================
   ТЕМА (ТЕМНАЯ/СВЕТЛАЯ)
   ========================= */
const darkToggle = document.getElementById('darkModeToggle');
const themeLabel = document.getElementById('current-theme');

function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
  } else {
    document.body.removeAttribute('data-theme');
  }
  updateThemeLabel();
}

function updateThemeLabel() {
  const theme = localStorage.getItem('theme') || 'light';
  themeLabel.textContent = 'Активна тема: ' + (theme === 'dark' ? 'темна' : 'світла');
}

/* =========================
   ПОДІЇ (onload)
   ========================= */
document.addEventListener('DOMContentLoaded', async () => {
  // 1) Завантажуємо налаштування до будь-чого
  settings = loadSettings();

  // 2) Применяем тему
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    applyTheme(savedTheme);
    if (savedTheme === 'dark') darkToggle.checked = true;
  } else {
    // По умолчанию светлая тема
    applyTheme('light');
    darkToggle.checked = false;
  }

  // 3) Історія чату (враховуючи налаштування saveHistory)
  chatHistory = loadChatHistory();
  if (!chatHistory.length || chatHistory[0]?.role !== 'system') {
    chatHistory.unshift({ role: "system", content: buildSystemPrompt(settings) });
  }

  // 4) Відновлюємо історію у UI
  if (chatHistory.length > 1) {
    for (let i = 1; i < chatHistory.length; i++) {
      const msg = chatHistory[i];
      if (msg.role === 'user') {
        appendMsg('user', msg.content);
      } else if (msg.role === 'assistant') {
        const formatted = saferFormatAssistant(msg.content, settings);
        appendMsg('assistant', formatted, true);
      }
    }
    appendMsg("assistant", `<span class="muted">Історія чату відновлена (${chatHistory.length - 1} повідомлень).</span>`, true);
  } else {
    appendMsg("assistant",
      `<span class="muted">🙏 Біблійний чат готовий! Відкрийте <strong>Налаштування</strong> для промпту, перекладу Біблії, AI параметрів та оформлення.</span>`,
      true
    );
  }

  // 5) Обробники UI - основные
  document.getElementById('settings-btn').addEventListener('click', openSettings);
  document.getElementById('close-settings').addEventListener('click', closeSettings);
  document.getElementById('factory-reset').addEventListener('click', factoryResetAll);
  document.getElementById('reset-prompt').addEventListener('click', () => {
    document.getElementById('systemPrompt').value = DEFAULT_PROMPT;
  });
  document.getElementById('reload-btn').addEventListener('click', () => loadModels(true));
  document.getElementById('clear-btn').addEventListener('click', clearChat);
  document.getElementById('send-btn').addEventListener('click', sendMessage);
  document.getElementById('user-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
  document.getElementById('temperature').addEventListener('input', (e) => {
    document.getElementById('temperature-display').textContent = e.target.value;
  });
  settingsBackdrop.addEventListener('click', (e) => { if (e.target === settingsBackdrop) closeSettings(); });

  // 6) Обработчики для модалки с вопросами
  document.getElementById('questions-btn').addEventListener('click', openQuestions);
  document.getElementById('close-questions').addEventListener('click', closeQuestions);
  questionsBackdrop.addEventListener('click', (e) => { if (e.target === questionsBackdrop) closeQuestions(); });

  // Обработчики для кнопок с вопросами
  document.querySelectorAll('.question-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('user-input').value = btn.textContent;
      closeQuestions();
      // Можно автоматически отправить сообщение
      // sendMessage();
    });
  });

  // 7) Обработчики для модалки помощи
  document.getElementById('help-btn').addEventListener('click', openHelp);
  document.getElementById('close-help').addEventListener('click', closeHelp);
  helpBackdrop.addEventListener('click', (e) => { if (e.target === helpBackdrop) closeHelp(); });

  // 8) Обработчик темы
  darkToggle.addEventListener('change', () => {
    if (darkToggle.checked) {
      localStorage.setItem('theme', 'dark');
      applyTheme('dark');
    } else {
      localStorage.setItem('theme', 'light');
      applyTheme('light');
    }
  });

  // 9) Збереження налаштувань з модалки
  document.getElementById('save-settings').addEventListener('click', () => {
    gatherSettingsFromUI();
    saveSettings();
    // оновлюємо system prompt у чаті
    chatHistory[0] = { role: "system", content: buildSystemPrompt(settings) };
    // повідомлення про мову
    const langNames = { uk: "українську", ru: "русскую", en: "English" };
    const currentLang = langNames[settings.responseLang] || settings.responseLang;
    appendMsg("assistant", `<span class="muted">Налаштування збережено. Мова відповідей: ${currentLang}. Системний промпт оновлено.</span>`, true);
    closeSettings();
  });

  // 10) Завантажуємо моделі після підйому UI і стану
  await loadModels(true);

  // 11) Фокус на інпут
  document.getElementById('user-input').focus();
});
</script>
</body>

</html>
