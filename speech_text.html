<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Голос в текст (локальная версия)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            padding: 15px;
            margin: 0;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .error {
            background: #ffebee;
            color: #d32f2f;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        button:disabled {
            background: #cccccc;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .instructions {
            font-size: 14px;
            color: #666;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h2>Голос в текст</h2>
    <div id="status">Готов к работе</div>
    
    <div class="instructions">
        <strong>Как использовать:</strong>
        <ol>
            <li>Нажмите "Начать запись"</li>
            <li>Разрешите доступ к микрофону</li>
            <li>Говорите четко в микрофон</li>
        </ol>
    </div>
    
    <textarea id="text" placeholder="Текст появится здесь..."></textarea>
    <button id="startBtn">Начать запись</button>
    <button id="stopBtn" disabled>Остановить</button>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const textArea = document.getElementById('text');
        
        let recognition;
        let isRecording = false;

        // Проверка поддержки API
        function checkSupport() {
            if (!('webkitSpeechRecognition' in window)) {
                statusEl.textContent = 'Ваш браузер не поддерживает распознавание речи';
                statusEl.className = 'error';
                startBtn.disabled = true;
                return false;
            }
            return true;
        }

        // Инициализация распознавания
        function initRecognition() {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'ru-RU';
            
            recognition.onstart = () => {
                isRecording = true;
                statusEl.textContent = 'Идет запись...';
                statusEl.className = 'success';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            };
            
            recognition.onerror = (event) => {
                let message = 'Ошибка: ';
                if (event.error === 'not-allowed') {
                    message += 'Доступ к микрофону запрещен. ';
                    if (window.chrome) {
                        message += 'В адресной строке нажмите на иконку 🔒 и разрешите микрофон.';
                    } else {
                        message += 'Обновите страницу и разрешите доступ.';
                    }
                } else {
                    message += event.error;
                }
                showError(message);
                stopRecording();
            };
            
            recognition.onresult = (event) => {
                let interim = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        textArea.value += event.results[i][0].transcript + '\n';
                    } else {
                        interim += event.results[i][0].transcript;
                    }
                }
                if (interim) {
                    textArea.value = textArea.value.replace(/\n$/, '') + interim;
                }
            };
            
            recognition.onend = () => {
                if (isRecording) {
                    recognition.start(); // Автоперезапуск
                }
            };
        }

        // Показать ошибку
        function showError(message) {
            statusEl.textContent = message;
            statusEl.className = 'error';
            console.error(message);
        }

        // Остановка записи
        function stopRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusEl.textContent = 'Готов к работе';
            statusEl.className = '';
        }

        // Основная инициализация
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkSupport()) return;
            
            initRecognition();
            
            startBtn.addEventListener('click', () => {
                if (!isRecording) {
                    textArea.value = '';
                    try {
                        recognition.start();
                    } catch(e) {
                        showError('Ошибка запуска: ' + e.message);
                    }
                }
            });
            
            stopBtn.addEventListener('click', stopRecording);
        });
    </script>
</body>
</html>