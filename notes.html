<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Система заметок - демо</title>
    <meta property="og:image" content="https://christian-word.github.io/chat/ico/notes.png" />
<style>
:root {
  --accent: #ffcc00;
  --bg: #f6f7fb;
  --card: #ffffff;
  --text: #222;
  --muted: #666;
  --primary: #1a73e8;
  --success: #2f7d32;
  --danger: #b00020;
  --sidebar: #f8f9fa;
  --border: #e5e5e5;
  --hover: #f0f0f0;
}

[data-theme="dark"] {
  --bg: #1a1a1a;
  --card: #2d2d2d;
  --text: #ffffff;
  --muted: #aaaaaa;
  --sidebar: #252525;
  --border: #444;
  --hover: #383838;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 350px;
  gap: 20px;
}

.main-content {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid var(--border);
}

.notes-sidebar {
  background: var(--card);
  border-radius: 12px;
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: fit-content;
  max-height: 80vh;
}

.notes-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--sidebar);
  border-radius: 12px 12px 0 0;
}

.notes-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.add-note-btn {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
}

.add-note-btn:hover {
  opacity: 0.9;
}

.notes-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
}

.notes-tab {
  flex: 1;
  background: none;
  border: none;
  padding: 12px 16px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  transition: all 0.2s;
}

.notes-tab.active {
  color: var(--primary);
  background: var(--hover);
  font-weight: 600;
}

.notes-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  min-height: 200px;
}

.note-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.note-item:hover {
  border-color: var(--primary);
  box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
}

.note-item.selected {
  border-color: var(--primary);
  background: rgba(26, 115, 232, 0.05);
}

.note-title {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 4px;
  color: var(--text);
}

.note-preview {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.4;
  max-height: 40px;
  overflow: hidden;
  margin-bottom: 8px;
}

.note-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  color: var(--muted);
}

.note-category {
  background: var(--primary);
  color: white;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 500;
}

.note-category.study { background: #2e7d32; }
.note-category.prayer { background: #7b1fa2; }
.note-category.sermon { background: #f57c00; }
.note-category.personal { background: #c2185b; }

.note-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  opacity: 0;
  transition: opacity 0.2s;
  display: flex;
  gap: 4px;
}

.note-item:hover .note-actions {
  opacity: 1;
}

.note-action-btn {
  background: var(--hover);
  border: none;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.note-action-btn:hover {
  background: var(--border);
}

.note-editor {
  background: var(--card);
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 20px;
  margin-top: 20px;
}

.note-editor h3 {
  margin: 0 0 16px;
  font-size: 18px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  font-size: 14px;
  color: var(--text);
}

.form-textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  font-size: 14px;
  color: var(--text);
  min-height: 200px;
  resize: vertical;
  font-family: inherit;
  line-height: 1.5;
}

.form-select {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  font-size: 14px;
  color: var(--text);
}

.form-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-secondary {
  background: var(--hover);
  color: var(--text);
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn:hover {
  opacity: 0.9;
}

.search-box {
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
}

.search-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  font-size: 14px;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
}

.demo-content {
  margin-bottom: 20px;
}

.demo-content h2 {
  color: var(--primary);
}

@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr;
  }
  
  .notes-sidebar {
    max-height: 50vh;
  }
}

/* Темная тема */
[data-theme="dark"] .form-input,
[data-theme="dark"] .form-textarea,
[data-theme="dark"] .form-select,
[data-theme="dark"] .search-input {
  background: var(--bg);
  color: var(--text);
  border-color: var(--border);
}

.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 12px;
  z-index: 1000;
}

/* Подсветка библейских ссылок в заметках */
.bible-ref-note {
  color: var(--primary);
  background: rgba(26, 115, 232, 0.1);
  padding: 1px 3px;
  border-radius: 3px;
  font-weight: 600;
  cursor: pointer;
}

.bible-ref-note:hover {
  background: rgba(26, 115, 232, 0.2);
}
</style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()">🌙 Тема</button>

<div class="container">
  <div class="main-content">
    <div class="demo-content">
      <h2>📝 Система заметок для библейского чата</h2>
      <p>Эта демонстрация показывает, как может выглядеть система заметок в вашем приложении.</p>
      
      <h3>Основные возможности:</h3>
      <ul>
        <li><strong>Категории заметок:</strong> Изучение, Молитва, Проповедь, Личное</li>
        <li><strong>Поиск:</strong> Быстрый поиск по заголовкам и содержимому</li>
        <li><strong>Библейские ссылки:</strong> Автоматическое выделение ссылок на Писание</li>
        <li><strong>Привязка к сессиям:</strong> Заметки могут быть связаны с чатами</li>
        <li><strong>Экспорт/импорт:</strong> Сохранение заметок в файл</li>
      </ul>

      <p>Попробуйте создать новую заметку или отредактировать существующую!</p>
    </div>

    <div class="note-editor" id="note-editor" style="display: none;">
      <h3 id="editor-title">Новая заметка</h3>
      <form id="note-form">
        <div class="form-group">
          <label for="note-title-input">Заголовок</label>
          <input type="text" id="note-title-input" class="form-input" placeholder="Введите заголовок заметки">
        </div>
        
        <div class="form-group">
          <label for="note-category-select">Категория</label>
          <select id="note-category-select" class="form-select">
            <option value="study">📖 Изучение</option>
            <option value="prayer">🙏 Молитва</option>
            <option value="sermon">🎤 Проповедь</option>
            <option value="personal">💭 Личное</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="note-bible-ref">Библейская ссылка (необязательно)</label>
          <input type="text" id="note-bible-ref" class="form-input" placeholder="напр: Пс. 23:1-6">
        </div>
        
        <div class="form-group">
          <label for="note-content">Содержание</label>
          <textarea id="note-content" class="form-textarea" placeholder="Введите текст заметки...&#10;&#10;Библейские ссылки будут автоматически выделены, например: (Ів. 3:16)"></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Отменить</button>
          <button type="button" class="btn btn-danger" id="delete-btn" onclick="deleteCurrentNote()" style="display: none;">Удалить</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>

  <div class="notes-sidebar">
    <div class="notes-header">
      <h3>📝 Заметки</h3>
      <button class="add-note-btn" onclick="createNewNote()">
        ➕ Нова
      </button>
    </div>
    
    <div class="search-box">
      <input type="text" class="search-input" id="search-input" placeholder="Поиск заметок...">
    </div>
    
    <div class="notes-tabs">
      <button class="notes-tab active" data-category="all">Все</button>
      <button class="notes-tab" data-category="study">Изучение</button>
      <button class="notes-tab" data-category="prayer">Молитва</button>
    </div>
    
    <div class="notes-list" id="notes-list">
      <!-- Заметки будут добавлены динамически -->
    </div>
  </div>
</div>

<script>
// Часть 1: Основной класс NotesManager

class NotesManager {
  constructor() {
    this.notes = this.loadNotes();
    this.currentNoteId = null;
    this.currentFilter = 'all';
    this.searchQuery = '';
    this.noteCounter = this.notes.length;
  }

  loadNotes() {
    const saved = localStorage.getItem('bible-notes');
    if (saved) {
      return JSON.parse(saved);
    }
    
    // Демо-данные для первого запуска
    return [
      {
        id: 'note_1',
        title: 'Размышления о Псалме 23',
        content: 'Господь - Пастырь мой (Пс. 23:1). В этом псалме Давид показывает полное доверие Богу. Особенно трогает стих "и милость Твоя будет сопровождать меня" (Пс. 23:6).\n\nКлючевые моменты:\n- Бог как пастырь\n- Покой у тихих вод\n- Долина смертной тени\n- Помазание головы елеем',
        category: 'study',
        bibleRef: 'Пс. 23',
        created: Date.now() - 86400000,
        modified: Date.now() - 86400000,
        sessionId: null
      },
      {
        id: 'note_2',
        title: 'Молитва о мудрости',
        content: 'Размышляя над (Як. 1:5) - "Если же у кого из вас недостает мудрости, да просит у Бога". Нужно чаще просить мудрости в принятии решений.\n\nСегодня молился о:\n- Решении о работе\n- Отношениях в семье\n- Служении в церкви',
        category: 'prayer',
        bibleRef: 'Як. 1:5',
        created: Date.now() - 172800000,
        modified: Date.now() - 172800000,
        sessionId: null
      },
      {
        id: 'note_3',
        title: 'Проповедь: Любовь Божья',
        content: 'План проповеди на тему любви Божьей:\n\n1. Введение - (1 Ів. 4:8) "Бог есть любовь"\n2. Проявление любви - (Ів. 3:16)\n3. Наш ответ - (1 Ів. 4:19) "мы любим Его, потому что Он прежде возлюбил нас"\n\nИллюстрация: притча о блудном сыне (Лк. 15:11-32)',
        category: 'sermon',
        bibleRef: '1 Ів. 4:8',
        created: Date.now() - 259200000,
        modified: Date.now() - 259200000,
        sessionId: null
      }
    ];
  }

  saveNotes() {
    localStorage.setItem('bible-notes', JSON.stringify(this.notes));
  }

  createNote(title, content, category, bibleRef = '', sessionId = null) {
    const note = {
      id: `note_${Date.now()}_${++this.noteCounter}`,
      title: title || 'Нова нотатка',
      content: content || '',
      category: category || 'personal',
      bibleRef: bibleRef,
      created: Date.now(),
      modified: Date.now(),
      sessionId: sessionId
    };
    
    this.notes.unshift(note); // Добавляем в начало массива
    this.saveNotes();
    this.renderNotes();
    return note.id;
  }

  updateNote(id, title, content, category, bibleRef = '') {
    const note = this.notes.find(n => n.id === id);
    if (note) {
      note.title = title;
      note.content = content;
      note.category = category;
      note.bibleRef = bibleRef;
      note.modified = Date.now();
      this.saveNotes();
      this.renderNotes();
      return true;
    }
    return false;
  }

  deleteNote(id) {
    const index = this.notes.findIndex(n => n.id === id);
    if (index !== -1) {
      this.notes.splice(index, 1);
      this.saveNotes();
      this.renderNotes();
      
      // Если удаляем текущую заметку, скрываем редактор
      if (this.currentNoteId === id) {
        this.currentNoteId = null;
        this.hideEditor();
      }
      return true;
    }
    return false;
  }

  getNoteById(id) {
    return this.notes.find(n => n.id === id);
  }

  searchNotes(query) {
    this.searchQuery = query.toLowerCase();
    this.renderNotes();
  }

  filterByCategory(category) {
    this.currentFilter = category;
    this.renderNotes();
  }

  getFilteredNotes() {
    let filtered = this.notes;
    
    // Фильтр по категории
    if (this.currentFilter !== 'all') {
      filtered = filtered.filter(note => note.category === this.currentFilter);
    }
    
    // Поиск по заголовку и содержимому
    if (this.searchQuery) {
      filtered = filtered.filter(note => 
        note.title.toLowerCase().includes(this.searchQuery) ||
        note.content.toLowerCase().includes(this.searchQuery) ||
        (note.bibleRef && note.bibleRef.toLowerCase().includes(this.searchQuery))
      );
    }
    
    return filtered;
  }
}

// Часть 2: Методы рендеринга и работы с UI

NotesManager.prototype.renderNotes = function() {
  const container = document.getElementById('notes-list');
  const filteredNotes = this.getFilteredNotes();
  
  if (filteredNotes.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <h3>Немає нотаток</h3>
        <p>${this.searchQuery ? 'Нічого не знайдено за запитом' : 'Створіть свою першу нотатку!'}</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = filteredNotes.map(note => this.renderNoteItem(note)).join('');
  
  // Привязываем обработчики событий
  this.attachNoteEventHandlers();
};

NotesManager.prototype.renderNoteItem = function(note) {
  const isSelected = note.id === this.currentNoteId;
  const preview = this.formatNotePreview(note.content);
  const categoryNames = {
    study: 'Вивчення',
    prayer: 'Молитва', 
    sermon: 'Проповідь',
    personal: 'Особисте'
  };
  
  return `
    <div class="note-item ${isSelected ? 'selected' : ''}" data-note-id="${note.id}">
      <div class="note-actions">
        <button class="note-action-btn edit-btn" title="Редагувати">✏️</button>
        <button class="note-action-btn delete-btn" title="Видалити">🗑️</button>
      </div>
      
      <div class="note-title">${this.escapeHTML(note.title)}</div>
      <div class="note-preview">${preview}</div>
      
      <div class="note-meta">
        <span class="note-category ${note.category}">
          ${categoryNames[note.category] || note.category}
        </span>
        <span>${this.formatDate(note.modified)}</span>
      </div>
    </div>
  `;
};

NotesManager.prototype.formatNotePreview = function(content) {
  // Убираем переносы строк и обрезаем до 100 символов
  const clean = content.replace(/\n/g, ' ').trim();
  const preview = clean.length > 100 ? clean.substring(0, 100) + '...' : clean;
  
  // Подсвечиваем библейские ссылки в превью
  return this.highlightBibleRefs(this.escapeHTML(preview));
};

NotesManager.prototype.highlightBibleRefs = function(text) {
  // Простое выделение библейских ссылок
  const bibleRefRegex = /\(([А-ЯІЄҐ][а-яіїєґ']+(?:\s[А-ЯІЄҐ][а-яіїєґ']+)*\.?\s*\d+(?::\d+(?:-\d+)?|-\d+)?)\)/g;
  return text.replace(bibleRefRegex, '<span class="bible-ref-note">($1)</span>');
};

NotesManager.prototype.formatDate = function(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
  
  if (diffInHours < 1) return 'Щойно';
  if (diffInHours < 24) return `${diffInHours} год тому`;
  if (diffInHours < 48) return 'Вчора';
  
  return date.toLocaleDateString('uk-UA', { 
    day: 'numeric', 
    month: 'short' 
  });
};

NotesManager.prototype.escapeHTML = function(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
};

NotesManager.prototype.attachNoteEventHandlers = function() {
  // Клик по заметке - выбор
  document.querySelectorAll('.note-item').forEach(item => {
    item.addEventListener('click', (e) => {
      if (e.target.classList.contains('note-action-btn')) return;
      
      const noteId = item.dataset.noteId;
      this.selectNote(noteId);
    });
  });
  
  // Кнопки редактирования
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const noteId = e.target.closest('.note-item').dataset.noteId;
      this.editNote(noteId);
    });
  });
  
  // Кнопки удаления
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const noteId = e.target.closest('.note-item').dataset.noteId;
      this.confirmDeleteNote(noteId);
    });
  });
};

NotesManager.prototype.selectNote = function(noteId) {
  this.currentNoteId = noteId;
  this.renderNotes(); // Перерендерим для выделения выбранной заметки
  
  // Можно добавить отображение полного содержимого заметки
  const note = this.getNoteById(noteId);
  if (note) {
    console.log('Выбрана заметка:', note.title);
  }
};

NotesManager.prototype.confirmDeleteNote = function(noteId) {
  const note = this.getNoteById(noteId);
  if (!note) return;
  
  if (confirm(`Видалити нотатку "${note.title}"?`)) {
    this.deleteNote(noteId);
  }
};

// Часть 3: Редактор заметок

NotesManager.prototype.showEditor = function(noteId = null) {
  const editor = document.getElementById('note-editor');
  const titleEl = document.getElementById('editor-title');
  const form = document.getElementById('note-form');
  const deleteBtn = document.getElementById('delete-btn');
  
  editor.style.display = 'block';
  editor.scrollIntoView({ behavior: 'smooth' });
  
  if (noteId) {
    // Редактирование существующей заметки
    const note = this.getNoteById(noteId);
    if (!note) return;
    
    titleEl.textContent = 'Редагувати нотатку';
    document.getElementById('note-title-input').value = note.title;
    document.getElementById('note-content').value = note.content;
    document.getElementById('note-category-select').value = note.category;
    document.getElementById('note-bible-ref').value = note.bibleRef || '';
    deleteBtn.style.display = 'inline-block';
    
    this.currentNoteId = noteId;
  } else {
    // Создание новой заметки
    titleEl.textContent = 'Нова нотатка';
    form.reset();
    deleteBtn.style.display = 'none';
    this.currentNoteId = null;
  }
  
  // Фокус на поле заголовка
  setTimeout(() => {
    document.getElementById('note-title-input').focus();
  }, 100);
};

NotesManager.prototype.hideEditor = function() {
  document.getElementById('note-editor').style.display = 'none';
  this.currentNoteId = null;
};

NotesManager.prototype.saveCurrentNote = function() {
  const title = document.getElementById('note-title-input').value.trim();
  const content = document.getElementById('note-content').value.trim();
  const category = document.getElementById('note-category-select').value;
  const bibleRef = document.getElementById('note-bible-ref').value.trim();
  
  if (!title || !content) {
    alert('Будь ласка, заповніть заголовок і зміст нотатки');
    return false;
  }
  
  if (this.currentNoteId) {
    // Обновление существующей заметки
    this.updateNote(this.currentNoteId, title, content, category, bibleRef);
  } else {
    // Создание новой заметки
    const newId = this.createNote(title, content, category, bibleRef);
    this.currentNoteId = newId;
  }
  
  this.hideEditor();
  return true;
};

NotesManager.prototype.editNote = function(noteId) {
  this.showEditor(noteId);
};

NotesManager.prototype.deleteCurrentNote = function() {
  if (!this.currentNoteId) return;
  
  const note = this.getNoteById(this.currentNoteId);
  if (!note) return;
  
  if (confirm(`Видалити нотатку "${note.title}"?`)) {
    this.deleteNote(this.currentNoteId);
    this.hideEditor();
  }
};

// Функции для интеграции с существующим чатом
NotesManager.prototype.createNoteFromMessage = function(messageContent, sessionId) {
  // Автоматически создаем заметку из сообщения чата
  const title = messageContent.substring(0, 50) + (messageContent.length > 50 ? '...' : '');
  const noteId = this.createNote(title, messageContent, 'study', '', sessionId);
  return noteId;
};

NotesManager.prototype.getNotesBySession = function(sessionId) {
  return this.notes.filter(note => note.sessionId === sessionId);
};

NotesManager.prototype.searchBibleReference = function(reference) {
  // Поиск заметок, содержащих определенную библейскую ссылку
  return this.notes.filter(note => 
    (note.bibleRef && note.bibleRef.includes(reference)) ||
    note.content.includes(reference)
  );
};

// Экспорт/импорт заметок
NotesManager.prototype.exportNotes = function() {
  const dataStr = JSON.stringify(this.notes, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `bible_notes_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  URL.revokeObjectURL(url);
  return true;
};

NotesManager.prototype.importNotes = function(jsonData) {
  try {
    const importedNotes = JSON.parse(jsonData);
    
    if (!Array.isArray(importedNotes)) {
      throw new Error('Невірний формат файлу');
    }
    
    // Добавляем импортированные заметки к существующим
    importedNotes.forEach(note => {
      // Проверяем обязательные поля
      if (note.id && note.title && note.content) {
        // Избегаем дубликатов по ID
        if (!this.getNoteById(note.id)) {
          this.notes.push(note);
        }
      }
    });
    
    this.saveNotes();
    this.renderNotes();
    return true;
  } catch (error) {
    console.error('Ошибка импорта:', error);
    return false;
  }
};

// Часть 4: Инициализация и глобальные функции

let notesManager;

// Глобальные функции для вызова из HTML
function createNewNote() {
  notesManager.showEditor();
}

function cancelEdit() {
  notesManager.hideEditor();
}

function deleteCurrentNote() {
  notesManager.deleteCurrentNote();
}

function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', currentTheme === 'dark' ? 'dark' : '');
  localStorage.setItem('notes-theme', currentTheme);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  // Создаем экземпляр менеджера заметок
  notesManager = new NotesManager();
  
  // Загружаем сохраненную тему
  const savedTheme = localStorage.getItem('notes-theme') || 'light';
  if (savedTheme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
  }
  
  // Первоначальный рендер заметок
  notesManager.renderNotes();
  
  // Обработчик формы сохранения заметки
  document.getElementById('note-form').addEventListener('submit', function(e) {
    e.preventDefault();
    notesManager.saveCurrentNote();
  });
  
  // Обработчик поиска
  document.getElementById('search-input').addEventListener('input', function(e) {
    notesManager.searchNotes(e.target.value);
  });
  
  // Обработчики табов категорий
  document.querySelectorAll('.notes-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      // Убираем активный класс у всех табов
      document.querySelectorAll('.notes-tab').forEach(t => t.classList.remove('active'));
      // Добавляем активный класс к текущему табу
      this.classList.add('active');
      
      // Фильтруем заметки по категории
      const category = this.dataset.category;
      notesManager.filterByCategory(category);
    });
  });
  
  // Обработчики клавиатурных сокращений
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + N - новая заметка
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      createNewNote();
    }
    
    // Ctrl/Cmd + S - сохранить заметку (если редактор открыт)
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      const editor = document.getElementById('note-editor');
      if (editor.style.display !== 'none') {
        e.preventDefault();
        notesManager.saveCurrentNote();
      }
    }
    
    // Escape - закрыть редактор
    if (e.key === 'Escape') {
      const editor = document.getElementById('note-editor');
      if (editor.style.display !== 'none') {
        cancelEdit();
      }
    }
  });
  
  // Автосохранение черновика каждые 30 секунд
  setInterval(function() {
    const editor = document.getElementById('note-editor');
    if (editor.style.display !== 'none') {
      const title = document.getElementById('note-title-input').value.trim();
      const content = document.getElementById('note-content').value.trim();
      
      if (title || content) {
        // Сохраняем черновик в localStorage
        const draft = {
          title,
          content,
          category: document.getElementById('note-category-select').value,
          bibleRef: document.getElementById('note-bible-ref').value.trim(),
          noteId: notesManager.currentNoteId,
          timestamp: Date.now()
        };
        localStorage.setItem('note-draft', JSON.stringify(draft));
      }
    }
  }, 30000);
  
  // Восстановление черновика при открытии редактора
  const savedDraft = localStorage.getItem('note-draft');
  if (savedDraft) {
    const draft = JSON.parse(savedDraft);
    // Проверяем, не слишком ли старый черновик (более часа)
    if (Date.now() - draft.timestamp < 3600000) {
      // Можно показать уведомление о наличии черновика
      console.log('Найден черновик заметки:', draft.title);
    } else {
      localStorage.removeItem('note-draft');
    }
  }
});

// API для интеграции с основным чатом
window.NotesAPI = {
  // Создать заметку из сообщения чата
  createFromMessage: function(messageContent, sessionId) {
    return notesManager.createNoteFromMessage(messageContent, sessionId);
  },
  
  // Получить заметки для сессии
  getSessionNotes: function(sessionId) {
    return notesManager.getNotesBySession(sessionId);
  },
  
  // Поиск заметок по библейской ссылке
  searchByReference: function(reference) {
    return notesManager.searchBibleReference(reference);
  },
  
  // Экспорт заметок
  export: function() {
    return notesManager.exportNotes();
  },
  
  // Импорт заметок
  import: function(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const success = notesManager.importNotes(e.target.result);
      if (success) {
        alert('Нотатки успішно імпортовано!');
      } else {
        alert('Помилка при імпорті файлу');
      }
    };
    reader.readAsText(file);
  },
  
  // Получить все заметки
  getAllNotes: function() {
    return notesManager.notes;
  },
  
  // Поиск заметок
  search: function(query) {
    notesManager.searchNotes(query);
  },
  
  // Создать новую заметку программно
  createNote: function(title, content, category = 'personal', bibleRef = '', sessionId = null) {
    return notesManager.createNote(title, content, category, bibleRef, sessionId);
  }
};

// Функции для добавления кнопок "Создать заметку" к сообщениям в чате
function addNoteButtonToMessage(messageElement, messageContent, sessionId) {
  const noteBtn = document.createElement('button');
  noteBtn.className = 'note-btn';
  noteBtn.innerHTML = '📝';
  noteBtn.title = 'Створити нотатку з цього повідомлення';
  noteBtn.onclick = function(e) {
    e.stopPropagation();
    const noteId = notesManager.createNoteFromMessage(messageContent, sessionId);
    alert('Нотатка створена!');
    
    // Показываем редактор для дальнейшего редактирования
    notesManager.editNote(noteId);
  };
  
  messageElement.appendChild(noteBtn);
}

console.log('Система заметок инициализирована');
console.log('API доступен через window.NotesAPI');

</script>
</body>

</html>
