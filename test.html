<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üéµ Google Drive MP3 Player (—Å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–µ–π)</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      padding: 20px;
      text-align: center;
    }
    h2 {
      color: #444;
    }
    #player {
      width: 80%;
      margin-top: 10px;
    }
    .controls {
      margin-top: 15px;
    }
    .controls button {
      padding: 8px 15px;
      margin: 0 5px;
      font-size: 14px;
    }
    #trackName {
      margin-top: 15px;
      font-weight: bold;
      font-size: 18px;
    }
    #timeDisplay {
      margin-top: 5px;
      font-size: 14px;
      color: #555;
    }
    #loading {
      display: none;
      margin-top: 10px;
      font-style: italic;
      color: #999;
    }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }
    li {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    li:hover {
      background: #e6e6e6;
    }
  </style>
</head>
<body>
  <h2>üéß Google Drive MP3 Player</h2>
  <div id="trackName">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤...</div>
  <audio id="player" controls></audio>
  <div id="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ ...</div>
  <div id="timeDisplay"></div>
  <div class="controls">
    <button onclick="prevTrack()">‚èÆÔ∏è –ù–∞–∑–∞–¥</button>
    <button onclick="replayTrack()">üîÅ –ü–æ–≤—Ç–æ—Ä</button>
    <button onclick="nextTrack()">‚è≠Ô∏è –í–ø–µ—Ä—ë–¥</button>
  </div>
  <ul id="trackList"></ul>

  <script>
    const API_KEY = "AIzaSyAlxAoAyke0AAkiI3akNyWLNVwtoycjkgA";
    const FOLDER_ID = "1GbUXLKzugx_W5qDttjtFxWC4pOT9kQna";

    const player = document.getElementById("player");
    const loading = document.getElementById("loading");
    const trackList = document.getElementById("trackList");
    const trackName = document.getElementById("trackName");
    const timeDisplay = document.getElementById("timeDisplay");

    let tracks = [], current = 0, currentBlobURL = null;

    async function fetchDriveFiles() {
      const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType='audio/mpeg'&key=${API_KEY}&fields=files(id,name)`;
      const res = await fetch(url);
      const data = await res.json();
      tracks = data.files.map(file => ({
        id: file.id,
        name: file.name
      }));
      buildList();
      playTrack(0);
    }

    function buildList() {
      trackList.innerHTML = "";
      tracks.forEach((track, i) => {
        const li = document.createElement("li");
        li.textContent = track.name;
        li.onclick = () => playTrack(i);
        trackList.appendChild(li);
      });
    }

    async function playTrack(index) {
      current = index;
      const file = tracks[index];

      // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫
      player.pause();
      player.src = "";
      timeDisplay.textContent = "";
      loading.style.display = "block";

      if (currentBlobURL) {
        URL.revokeObjectURL(currentBlobURL);
        currentBlobURL = null;
      }

      try {
        trackName.textContent = `üîä ${file.name}`;
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=${API_KEY}`);
        if (!response.ok) {
          throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + response.status);
        }
        const blob = await response.blob();
        currentBlobURL = URL.createObjectURL(blob);
        player.src = currentBlobURL;
        player.play().then(() => {
          loading.style.display = "none";
        }).catch(err => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏:", err);
          loading.style.display = "none";
        });
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", err.message);
        trackName.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
        loading.style.display = "none";
      }
    }

    function nextTrack() {
      current = (current + 1) % tracks.length;
      playTrack(current);
    }

    function prevTrack() {
      current = (current - 1 + tracks.length) % tracks.length;
      playTrack(current);
    }

    function replayTrack() {
      playTrack(current);
    }

    player.addEventListener("ended", nextTrack);

    player.addEventListener("timeupdate", () => {
      const currentTime = formatTime(player.currentTime);
      const duration = formatTime(player.duration);
      timeDisplay.textContent = `${currentTime} / ${duration}`;
    });

    player.addEventListener("pause", () => {
      loading.style.display = "none";
    });

    player.addEventListener("playing", () => {
      loading.style.display = "none";
    });

    function formatTime(seconds) {
      if (isNaN(seconds)) return "0:00";
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60).toString().padStart(2, "0");
      return `${min}:${sec}`;
    }

    fetchDriveFiles();
  </script>
</body>
</html>
